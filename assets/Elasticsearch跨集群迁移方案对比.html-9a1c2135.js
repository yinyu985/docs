import{_ as p,W as l,X as o,Y as n,Z as s,$ as t,a0 as a,D as i}from"./framework-b4edc447.js";const r={},c=a('<h1 id="elasticsearch跨集群迁移方案对比" tabindex="-1"><a class="header-anchor" href="#elasticsearch跨集群迁移方案对比" aria-hidden="true">#</a> Elasticsearch跨集群迁移方案对比</h1><p>根据以上汇总出如下四种方案，并对其各项特点进行分析，最终选择适合我们自身的迁移方案。</p><table><thead><tr><th><strong>方案</strong></th><th><strong>elasticsearch-dump</strong></th><th><strong>reindex</strong></th><th><strong>snapshot</strong></th><th><strong>logstash</strong></th></tr></thead><tbody><tr><td>基本原理</td><td>逻辑备份，类似mysqldump将数据一条一条导出后再执行导入</td><td>reindex 是 Elasticsearch 提供的一个 API 接口，可以把数据从一个集群迁移到另外一个集群</td><td>从源集群通过Snapshot API 创建数据快照，然后在目标集群中进行恢复</td><td>从一个集群中读取数据然后写入到另一个集群</td></tr><tr><td>网络要求</td><td>集群间互导需要网络互通，先导出文件再通过文件导入集群则不需要网络互通</td><td>网络需要互通</td><td>无网络互通要求</td><td>网络需要互通</td></tr><tr><td>迁移速度</td><td>慢</td><td>快</td><td>快</td><td>一般</td></tr><tr><td>适合场景</td><td>适用于数据量小的场景</td><td>适用于数据量不大，在线迁移数据的场景</td><td>适用于数据量大，接受离线数据迁移的场景</td><td>适用于数据量一般，近实时数据传输</td></tr><tr><td>配置复杂度</td><td>中等</td><td>简单</td><td>复杂</td><td>中等</td></tr></tbody></table>',3),d=n("strong",null,"scroll query + bulk",-1),u={href:"https://www.elastic.co/guide/en/elasticsearch/reference/8.5/snapshots-register-repository.html#self-managed-repo-types",target:"_blank",rel:"noopener noreferrer"},m=a(`<h1 id="方案测试" tabindex="-1"><a class="header-anchor" href="#方案测试" aria-hidden="true">#</a> <strong>方案测试</strong></h1><p>开始对以上各种方案进行测试对比，准备两台测试用的elasticsearch，要求有kibana,x-pack白金版</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>http://10.23.188.99:5601/  <span class="token comment">###一台在采集/var/log/messages日志的ELK全套</span>
http://10.23.191.99:5601/  <span class="token comment">###一台空的elasticsearch</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>后面将以188和191区分二者</p><h2 id="测试-snapshot" tabindex="-1"><a class="header-anchor" href="#测试-snapshot" aria-hidden="true">#</a> <strong>测试:snapshot</strong></h2><p>因为只是测试，选择最基础的配置，在elasticsearch的配置文件末尾加上path.repo: [&quot;/data/backup&quot;]创建对应的文件夹，并且需要对es用户赋权限，因为我们的elasticsearch是专门创建了一个es的用户去运行的，然后重启elasticsearch生效。 访问188的kibana的开发工具界面，执行以下。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">#这里注册了一个名为backup的共享文件系统仓库,快照会存储在/home/backup目录,需要给es用户所有权，不然创建失败</span>
PUT _snapshot/backup
<span class="token punctuation">{</span>
    <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;fs&quot;</span>,
    <span class="token string">&quot;settings&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;location&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;/data/backup&quot;</span>,
        <span class="token string">&quot;compress&quot;</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
GET _snapshot?pretty    <span class="token comment">#查看文件仓库创建的执行结果?pretty是美化返回结果</span>
GET _snapshot/_all?pretty   <span class="token comment">#查看所有的仓库</span>
PUT /_snapshot/backup/snapshot_test   <span class="token comment">#创建一个快照名叫snapshot_test，它包含所有以\`messages_\`开头的索引，经过测试它是支持通配符的。</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;indices&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;messages_*&quot;</span>,
    <span class="token string">&quot;ignore_unavailable&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;true&quot;</span>,   
    <span class="token string">&quot;include_global_state&quot;</span><span class="token builtin class-name">:</span> false,
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>各项参数解释，为了提高快照和恢复的速度，保证过程不出错，需要详细对每一项参数掌握。 以下是创建快照的可选参数</p><table><thead><tr><th><strong>Setting</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td>indices</td><td>The indices you want to include in the snapshot. You can use , to create a list of indices, * to specify an index pattern, and - to exclude certain indices. Don’t put spaces between items. Default is all indices.（不建议把旧es的kibana索引制作快照同步到新es，会导致kibana出错）</td></tr><tr><td>ignore_unavailable</td><td>If an index from the indices list doesn’t exist, whether to ignore it rather than fail the snapshot. Default is false.</td></tr><tr><td>include_global_state</td><td>Whether to include cluster state in the snapshot. Default is true.</td></tr><tr><td>partial</td><td>Whether to allow partial snapshots. Default is false, which fails the entire snapshot if one or more shards fails to store.是否允许部分快照。默认为 false，如果一个或多个分片存储失败，则整个快照失败。</td></tr><tr><td>以下是设置快照仓库的可选参数</td><td></td></tr><tr><td>location</td><td>指定快照的存储位置。必须要有</td></tr><tr><td>--------------------------</td><td>------------------------------------------------------------</td></tr><tr><td>compress</td><td>指定是否对快照文件进行压缩. 默认是 true.</td></tr><tr><td>chunk_size</td><td>如果需要在做快照的时候大文件可以被分解成几块。这个参数指明了每块的字节数。也可用不同的单位标识。 比如，1g，10m，5k等。默认是 null (表示不限制块大小)。</td></tr><tr><td>max_restore_bytes_per_sec</td><td>每个节点恢复数据的最高速度限制. 默认是 20mb/s</td></tr><tr><td>max_snapshot_bytes_per_sec</td><td>每个节点做快照的最高速度限制。默认是 20mb/s</td></tr><tr><td>以下是恢复快照的可选参数</td><td></td></tr><tr><td>Setting</td><td><strong>Description</strong></td></tr><tr><td>---------------------</td><td>------------------------------------------------------------</td></tr><tr><td>indices</td><td>The indices you want to restore. You can use , to create a list of indices, * to specify an index pattern, and - to exclude certain indices. Don’t put spaces between items. Default is all indices.</td></tr><tr><td>ignore_unavailable</td><td>If an index from the indices list doesn’t exist, whether to ignore it rather than fail the restore operation. Default is false.</td></tr><tr><td>include_global_state</td><td>Whether to restore the cluster state. Default is false.</td></tr><tr><td>include_aliases</td><td>Whether to restore aliases alongside their associated indices. Default is true.</td></tr><tr><td>partial</td><td>Whether to allow the restoration of partial snapshots. Default is false.</td></tr><tr><td>rename_pattern</td><td>If you want to rename indices as you restore them, use this option to specify a regular expression that matches all indices you want to restore. Use capture groups (()) to reuse portions of the index name.</td></tr><tr><td>rename_replacement</td><td>If you want to rename indices as you restore them, use this option to specify the replacement pattern. Use $0 to include the entire matching index name, $1 to include the content of the first capture group, etc.</td></tr><tr><td>index_settings</td><td>If you want to change index settings on restore, specify them here.</td></tr><tr><td>ignore_index_settings</td><td>Rather than explicitly specifying new settings with index_settings, you can ignore certain index settings in the snapshot and use the cluster defaults on restore.</td></tr><tr><td>在开发工具界面看到执行成功后，可以前往刚才配置的仓库路径查看</td><td></td></tr></tbody></table><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@network_test_elk home<span class="token punctuation">]</span><span class="token comment"># cd backup/</span>
<span class="token punctuation">[</span>root@network_test_elk backup<span class="token punctuation">]</span><span class="token comment"># ll</span>
总用量 <span class="token number">32</span>
-rw-r--r--  <span class="token number">1</span> es es <span class="token number">12931</span> <span class="token number">1</span>月   <span class="token number">3</span> <span class="token number">19</span>:30 index-0
-rw-r--r--  <span class="token number">1</span> es es     <span class="token number">8</span> <span class="token number">1</span>月   <span class="token number">3</span> <span class="token number">19</span>:30 index.latest
drwxr-xr-x <span class="token number">51</span> es es  <span class="token number">4096</span> <span class="token number">1</span>月   <span class="token number">3</span> <span class="token number">19</span>:30 indices
-rw-r--r--  <span class="token number">1</span> es es   <span class="token number">193</span> <span class="token number">1</span>月   <span class="token number">3</span> <span class="token number">19</span>:30 meta-82OPqtLbS-y1sgz6hZBCuw.dat
-rw-r--r--  <span class="token number">1</span> es es   <span class="token number">419</span> <span class="token number">1</span>月   <span class="token number">3</span> <span class="token number">19</span>:30 snap-82OPqtLbS-y1sgz6hZBCuw.dat
<span class="token comment">####################################这些就是创建一次快照产生的文件#############################################</span>
<span class="token punctuation">[</span>root@network_test_elk backup<span class="token punctuation">]</span><span class="token comment"># ll &gt;ll.txt ###将ll的结果保存到ll.txt,然后第二条重新创建了一次快照，对比文件变化。</span>
<span class="token punctuation">[</span>root@network_test_elk backup<span class="token punctuation">]</span><span class="token comment"># ll</span>
总用量 <span class="token number">36</span>
-rw-r--r--  <span class="token number">1</span> es   es   <span class="token number">12931</span> <span class="token number">1</span>月   <span class="token number">3</span> <span class="token number">19</span>:30 index-0
-rw-r--r--  <span class="token number">1</span> es   es       <span class="token number">8</span> <span class="token number">1</span>月   <span class="token number">3</span> <span class="token number">19</span>:30 index.latest
drwxr-xr-x <span class="token number">51</span> es   es    <span class="token number">4096</span> <span class="token number">1</span>月   <span class="token number">3</span> <span class="token number">19</span>:30 indices
-rw-r--r--  <span class="token number">1</span> root root   <span class="token number">383</span> <span class="token number">1</span>月   <span class="token number">4</span> <span class="token number">14</span>:54 ll.txt
-rw-r--r--  <span class="token number">1</span> es   es     <span class="token number">193</span> <span class="token number">1</span>月   <span class="token number">3</span> <span class="token number">19</span>:30 meta-82OPqtLbS-y1sgz6hZBCuw.dat
-rw-r--r--  <span class="token number">1</span> es   es     <span class="token number">419</span> <span class="token number">1</span>月   <span class="token number">3</span> <span class="token number">19</span>:30 snap-82OPqtLbS-y1sgz6hZBCuw.dat
<span class="token punctuation">[</span>root@network_test_elk backup<span class="token punctuation">]</span><span class="token comment"># ll</span>
总用量 <span class="token number">48</span>
-rw-r--r--  <span class="token number">1</span> es   es   <span class="token number">17517</span> <span class="token number">1</span>月   <span class="token number">4</span> <span class="token number">14</span>:54 index-1
-rw-r--r--  <span class="token number">1</span> es   es       <span class="token number">8</span> <span class="token number">1</span>月   <span class="token number">4</span> <span class="token number">14</span>:54 index.latest
drwxr-xr-x <span class="token number">52</span> es   es    <span class="token number">4096</span> <span class="token number">1</span>月   <span class="token number">4</span> <span class="token number">14</span>:54 indices
-rw-r--r--  <span class="token number">1</span> root root   <span class="token number">383</span> <span class="token number">1</span>月   <span class="token number">4</span> <span class="token number">14</span>:54 ll.txt
-rw-r--r--  <span class="token number">1</span> es   es     <span class="token number">193</span> <span class="token number">1</span>月   <span class="token number">3</span> <span class="token number">19</span>:30 meta-82OPqtLbS-y1sgz6hZBCuw.dat
-rw-r--r--  <span class="token number">1</span> es   es     <span class="token number">193</span> <span class="token number">1</span>月   <span class="token number">4</span> <span class="token number">14</span>:54 meta-e129JOLcScyCjseeC-K6Fg.dat
-rw-r--r--  <span class="token number">1</span> es   es     <span class="token number">419</span> <span class="token number">1</span>月   <span class="token number">3</span> <span class="token number">19</span>:30 snap-82OPqtLbS-y1sgz6hZBCuw.dat
-rw-r--r--  <span class="token number">1</span> es   es     <span class="token number">420</span> <span class="token number">1</span>月   <span class="token number">4</span> <span class="token number">14</span>:54 snap-e129JOLcScyCjseeC-K6Fg.dat
<span class="token punctuation">[</span>root@network_test_elk backup<span class="token punctuation">]</span><span class="token comment"># cat ll.txt </span>
总用量 <span class="token number">32</span>
-rw-r--r--  <span class="token number">1</span> es   es   <span class="token number">12931</span> <span class="token number">1</span>月   <span class="token number">3</span> <span class="token number">19</span>:30 index-0
-rw-r--r--  <span class="token number">1</span> es   es       <span class="token number">8</span> <span class="token number">1</span>月   <span class="token number">3</span> <span class="token number">19</span>:30 index.latest
drwxr-xr-x <span class="token number">51</span> es   es    <span class="token number">4096</span> <span class="token number">1</span>月   <span class="token number">3</span> <span class="token number">19</span>:30 indices
-rw-r--r--  <span class="token number">1</span> root root     <span class="token number">0</span> <span class="token number">1</span>月   <span class="token number">4</span> <span class="token number">14</span>:54 ll.txt
-rw-r--r--  <span class="token number">1</span> es   es     <span class="token number">193</span> <span class="token number">1</span>月   <span class="token number">3</span> <span class="token number">19</span>:30 meta-82OPqtLbS-y1sgz6hZBCuw.dat
-rw-r--r--  <span class="token number">1</span> es   es     <span class="token number">419</span> <span class="token number">1</span>月   <span class="token number">3</span> <span class="token number">19</span>:30 snap-82OPqtLbS-y1sgz6hZBCuw.dat
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建快照的工作已经完成，在191新建一个文件仓库（跟前一个的es操作一样），重启后打开kibana界面 将刚才在另一台的快照文件通过scp -r 发送到当前es，然后可以通过kibana查看快照是否被正常识别</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>GET _snapshot/backup/_all?pretty
<span class="token comment"># 查看所有的快照</span>
POST _snapshot/backup/snapshot_test/_restore?pretty
<span class="token comment"># 恢复snapshot_test这个快照</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其实在kibana的开发工具的操作，也是可以通过可视化界面通过鼠标操作实现,测试中一共导入了85M，50个索引，制作快照和恢复快照的时间累计不超过五秒，虽然snapshot是最快的方案，但是仍要对其速度有所了解，准备一个1G的索引再次测试。</p><h2 id="测试-elasticsearch-dump" tabindex="-1"><a class="header-anchor" href="#测试-elasticsearch-dump" aria-hidden="true">#</a> <strong>测试:elasticsearch-dump</strong></h2>`,14),k={href:"https://github.com/elasticsearch-dump/elasticsearch-dump",target:"_blank",rel:"noopener noreferrer"},b=a(`<div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>yum <span class="token function">install</span> nodejs <span class="token parameter variable">-y</span>
yum <span class="token function">install</span> <span class="token function">npm</span> <span class="token parameter variable">-y</span> 
<span class="token function">npm</span> <span class="token function">install</span> elasticdump <span class="token parameter variable">-g</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在网络ELK中选取一个大小为1G的索引，用elasticdump ，填写基本用户认证开始测试。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>elasticdump <span class="token punctuation">\\</span>
  <span class="token parameter variable">--input</span><span class="token operator">=</span>http://name:passw@localhost:9200/netops_pa_device-2022-12-15 <span class="token punctuation">\\</span>
  <span class="token parameter variable">--output</span><span class="token operator">=</span>http://name:passw@10.23.191.99:9200/netops_pa_device-2022-12-15 <span class="token punctuation">\\</span>
  <span class="token parameter variable">--type</span><span class="token operator">=</span>mapping
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://s2.loli.net/2023/01/06/p3osaMyELH5lO8K.png" alt="image-20230106182859431" loading="lazy"> 直接从原es导入到新es，导入mapping用户基本可以忽略。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>elasticdump <span class="token punctuation">\\</span>
  <span class="token parameter variable">--input</span><span class="token operator">=</span>http://name:passw@localhost:9200/netops_pa_device-2022-12-15 <span class="token punctuation">\\</span>
  <span class="token parameter variable">--output</span><span class="token operator">=</span>http://name:password@10.23.191.99:9200/netops_pa_device-2022-12-15 <span class="token punctuation">\\</span>
  <span class="token parameter variable">--type</span><span class="token operator">=</span>data
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://s2.loli.net/2023/01/06/xp7c8EhovwA563J.png" alt="img" loading="lazy"> 导入1G索引的data，用时十分漫长，由于时间太长，会话中断后，传输也会被中断，于是我们借助一个工具</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>yum <span class="token function">install</span> <span class="token function">screen</span> <span class="token parameter variable">-y</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>screen 是一个非常有用的命令，提供从单个 SSH 会话中使用多个 shell 窗口（会话）的能力。当会话被分离或网络中断时，screen 会话中启动的进程仍将运行，你可以随时重新连接到 screen 会话</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">screen</span> <span class="token parameter variable">-S</span> session_name           <span class="token comment"># 新建一个叫session_name的session</span>
<span class="token function">screen</span> -ls（或者screen -list）     <span class="token comment"># 列出当前所有的session</span>
<span class="token function">screen</span> <span class="token parameter variable">-r</span> session_name            <span class="token comment"># 回到session_name这个session</span>
<span class="token function">screen</span> <span class="token parameter variable">-d</span> session_name           <span class="token comment"># 远程detach某个session</span>
<span class="token function">screen</span> <span class="token parameter variable">-d</span> <span class="token parameter variable">-r</span> session_name        <span class="token comment"># 结束当前session并回到session_name这个session</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>具体操作如下</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token shebang important">#!/bin/sh</span>
<span class="token builtin class-name">echo</span> <span class="token variable"><span class="token variable">\`</span><span class="token function">date</span><span class="token variable">\`</span></span> <span class="token operator">&gt;</span>~/dump.log
elasticdump <span class="token punctuation">\\</span>
  <span class="token parameter variable">--input</span><span class="token operator">=</span>http://elastic:XXXXXXXXXXXX@localhost:9200/netops_pa_device-2022-12-15 <span class="token punctuation">\\</span>
  <span class="token parameter variable">--output</span><span class="token operator">=</span>http://elastic:XXXXXXXXXXXX@10.23.191.99:9200/netops_pa_device-2022-12-15 <span class="token punctuation">\\</span>
  <span class="token parameter variable">--type</span><span class="token operator">=</span>mapping <span class="token operator">&gt;&gt;</span>~/dump.log
elasticdump <span class="token punctuation">\\</span>
  <span class="token parameter variable">--input</span><span class="token operator">=</span>http://elastic:XXXXXXXXXXXX@localhost:9200/netops_pa_device-2022-12-15 <span class="token punctuation">\\</span>
  <span class="token parameter variable">--output</span><span class="token operator">=</span>http://elastic:XXXXXXXXXXXX@10.23.191.99:9200/netops_pa_device-2022-12-15 <span class="token punctuation">\\</span>
  <span class="token parameter variable">--type</span><span class="token operator">=</span>data <span class="token operator">&gt;&gt;</span> ~/dump.log 
<span class="token builtin class-name">echo</span> <span class="token variable"><span class="token variable">\`</span><span class="token function">date</span><span class="token variable">\`</span></span> <span class="token operator">&gt;&gt;</span>~/dump.log
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>用screen新建一个会话，在会话中执行这个脚本。最后将两个时间相减就能够得到整体的运行耗时。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@es_network ~<span class="token punctuation">]</span><span class="token comment"># grep 日 dump.log </span>
<span class="token number">2023</span>年 01月 05日 星期四 <span class="token number">13</span>:05:59 CST
<span class="token number">2023</span>年 01月 05日 星期四 <span class="token number">20</span>:03:48 CST
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>七小时后终于把1GB的索引传到了新的es。</p><h2 id="测试-logstash" tabindex="-1"><a class="header-anchor" href="#测试-logstash" aria-hidden="true">#</a> <strong>测试:logstash</strong></h2><h5 id="迁移全量数据" tabindex="-1"><a class="header-anchor" href="#迁移全量数据" aria-hidden="true">#</a> <strong>迁移全量数据</strong></h5><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>input<span class="token punctuation">{</span>
    elasticsearch<span class="token punctuation">{</span>
        <span class="token comment"># 源端ES地址。</span>
        hosts <span class="token operator">=</span><span class="token operator">&gt;</span>  <span class="token punctuation">[</span><span class="token string">&quot;http://localhost:9200&quot;</span><span class="token punctuation">]</span>
        <span class="token comment"># 安全集群配置登录用户名密码。</span>
        user <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;xxxxxx&quot;</span>
        password <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;xxxxxx&quot;</span>
        <span class="token comment"># 需要迁移的索引列表，多个索引以英文以逗号（,）分隔。</span>
        index <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;kibana_sample_data_*&quot;</span>
        <span class="token comment"># 以下三项保持默认即可，包含线程数和迁移数据大小和Logstash JVM配置相关。</span>
        <span class="token assign-left variable">docinfo</span><span class="token operator">=</span><span class="token operator">&gt;</span>true
        slices <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">5</span>
        size <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">5000</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
filter <span class="token punctuation">{</span>
  <span class="token comment"># 去掉一些Logstash自己加的字段。</span>
  mutate <span class="token punctuation">{</span>
    remove_field <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token string">&quot;@timestamp&quot;</span>, <span class="token string">&quot;@version&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
output<span class="token punctuation">{</span>
    elasticsearch<span class="token punctuation">{</span>
        <span class="token comment"># 目标端ES地</span>
        hosts <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token string">&quot;http://8.8.8.8:9200&quot;</span><span class="token punctuation">]</span>
        <span class="token comment"># 安全集群配置登录用户名密码。</span>
        user <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;elastic&quot;</span>
        password <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;xxxxxx&quot;</span>
        <span class="token comment"># 目标端索引名称，以下配置表示索引与源端保持一致。</span>
        index <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;%{[@metadata][_index]}&quot;</span>
        <span class="token comment"># 目标端索引type，以下配置表示索引类型与源端保持一致。</span>
        document_type <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;%{[@metadata][_type]}&quot;</span>
        <span class="token comment"># 目标端数据的id，如果不需要保留原id，可以删除以下这行，删除后性能会更好。</span>
        document_id <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;%{[@metadata][_id]}&quot;</span>
        ilm_enabled <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>
        manage_template <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="迁移增量数据" tabindex="-1"><a class="header-anchor" href="#迁移增量数据" aria-hidden="true">#</a> <strong>迁移增量数据</strong></h5><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>input<span class="token punctuation">{</span>
    elasticsearch<span class="token punctuation">{</span>
        <span class="token comment"># 源端ES地址。</span>
        hosts <span class="token operator">=</span><span class="token operator">&gt;</span>  <span class="token punctuation">[</span><span class="token string">&quot;http://localhost:9200&quot;</span><span class="token punctuation">]</span>
        <span class="token comment"># 安全集群配置登录用户名密码。</span>
        user <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;xxxxxx&quot;</span>
        password <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;xxxxxx&quot;</span>
        <span class="token comment"># 需要迁移的索引列表，多个索引使用英文逗号（,）分隔。</span>
        index <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;kibana_sample_data_logs&quot;</span>
        <span class="token comment"># 按时间范围查询增量数据，以下配置表示查询最近5分钟的数据。</span>
        query <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&#39;{&quot;query&quot;:{&quot;range&quot;:{&quot;@timestamp&quot;:{&quot;gte&quot;:&quot;now-5m&quot;,&quot;lte&quot;:&quot;now/m&quot;}}}}&#39;</span>
        <span class="token comment"># 定时任务，以下配置表示每分钟执行一次。</span>
        schedule <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;* * * * *&quot;</span>
        scroll <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;5m&quot;</span>
        <span class="token assign-left variable">docinfo</span><span class="token operator">=</span><span class="token operator">&gt;</span>true
        size <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">5000</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
filter <span class="token punctuation">{</span>
  <span class="token comment"># 去掉一些Logstash自己加的字段.</span>
  mutate <span class="token punctuation">{</span>
    remove_field <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token string">&quot;@timestamp&quot;</span>, <span class="token string">&quot;@version&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
output<span class="token punctuation">{</span>
    elasticsearch<span class="token punctuation">{</span>
        <span class="token comment"># 目标端ES地址</span>
        hosts <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token string">&quot;http://8.8.8.8:9200&quot;</span><span class="token punctuation">]</span>
        <span class="token comment"># 安全集群配置登录用户名密码.</span>
        user <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;elastic&quot;</span>
        password <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;xxxxxx&quot;</span>
        <span class="token comment"># 目标端索引名称，以下配置表示索引与源端保持一致。</span>
        index <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;%{[@metadata][_index]}&quot;</span>
        <span class="token comment"># 目标端索引type，以下配置表示索引类型与源端保持一致。</span>
        document_type <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;%{[@metadata][_type]}&quot;</span>
        <span class="token comment"># 目标端数据的id，如果不需要保留原id，可以删除以下这行，删除后性能会更好。</span>
        document_id <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;%{[@metadata][_id]}&quot;</span>
        ilm_enabled <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>
        manage_template <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>logstash迁移1Gb索引用时15分钟，总的来说也是挺慢的。</p><h2 id="测试-reindex" tabindex="-1"><a class="header-anchor" href="#测试-reindex" aria-hidden="true">#</a> <strong>测试:reindex</strong></h2><p>ES在创建好索引后，mapping的properties属性类型是不能更改的，只能添加。如果说需要修改字段就需要重新建立索引然后把旧数据导到新索引。这时候就可以用reindex 首先为新的索引新建一个mapping，mapping中可以修改你要修改的字段的类型，再加入以下内容，优化导入效率。 修改了number_of_replicas和refresh_interval。</p><ul><li>设置number_of_replicas为0防止我们迁移文档的同时又发送到副本节点，影响性能。</li><li>设置refresh_interval为-1是限制其刷新。默认是1秒 当我们数据导入完成后再把上面两个值进行修改即可。</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>POST /_reindex
<span class="token punctuation">{</span>
  <span class="token string">&quot;source&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;index&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;topic&quot;</span>
      <span class="token punctuation">}</span>,
  <span class="token string">&quot;dest&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;index&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;topic-new&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上是reindex在同一集群中的使用，在跨集群时也能用于索引迁移。 在目标 ES 集群中配置 elasticsearch.yml中的reindex.remote.whitelist 参数，指明能够 reindex 的远程集群的白名单。</p><ul><li>和同集群数据迁移基本一样，就是多了一个设置白名单而已。</li><li>设置好索引、number_of_replicas: 0、refresh_interval: -1</li><li>在remote中设置远程集群的地址与账号密码（如果配置了的话）。</li><li>也可以添加query属性，只查询符号条件的。 在新机器的kibana开发工具界面执行如下，实测1GB索引导入用时10分钟</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>POST _reindex
<span class="token punctuation">{</span>
  <span class="token string">&quot;conflicts&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;proceed&quot;</span>, 
  <span class="token string">&quot;source&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;remote&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;host&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;http://10.23.188.108:9200&quot;</span>,
      <span class="token string">&quot;username&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;elastic&quot;</span>,
      <span class="token string">&quot;password&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;**********&quot;</span>,
      <span class="token string">&quot;socket_timeout&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1m&quot;</span>,
      <span class="token string">&quot;connect_timeout&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1m&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;index&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;netops_pa_device-2022-12-15&quot;</span>,
    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">5000</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;dest&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;index&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;netops_pa_device-2022-12-15&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>完成之后记得重新配置number_of_replicas、refresh_interval。 Using wait_for_completion=false as query param will return the task id and you will be able to monitor the reindex progress using GET /_tasks/&lt;task_id&gt;. ###在GET请求时，设置 wait_for_completion=false，将会返回一个taskid，可以通过taskid获取这个导入的task的进度 In order to improve the speed, you should reduce the replicas to 0 and set refresh_interval=-1 in the destination index bevore reindexing and reset the values afterwards. ###为了提高速度，可以降低分片数到0，并且设置刷新时间为-1，在迁移完成后设置成原来的值。</p>`,28);function v(h,g){const e=i("ExternalLinkIcon");return l(),o("div",null,[c,n("p",null,[s("elasticsearch-dump、logstash、reindex、snapshot方式进行数据迁移，实际上这几种工具大体上可以分为以下几类： "),d,s(":批量读取旧集群的数据然后再批量写入新集群，elasticsearch-dump、logstash、reindex都是采用这种方式 **snapshot:**直接把旧集群的底层的文件进行备份，在新的集群中恢复出来，相比较scroll query + bulk的方式，snapshot的方式迁移速度最快。 从源 ES 集群通过备份api创建数据快照，然后在目标 ES 集群中进行恢复，无网络互通要求、迁移速度快、运维配置简单、适用于数据量大，接受离线数据迁移的场景,Snapshot and restore 模块允许创建单个索引或者整个集群的快照到远程仓库。所以首先需要创建一个存储快照的地方，存储方案可以选择一个NFS的共享存储，或者对象存储，详细要求参见"),n("a",u,[s("https://www.elastic.co/guide/en/elasticsearch/reference/8.5/snapshots-register-repository.html#self-managed-repo-types"),t(e)])]),m,n("p",null,[s("elasticsearch-dump是一个开源的Elasticsearch数据迁移工具，详细信息请参见"),n("a",k,[s("elasticsearch-dump官方文档"),t(e)]),s("。 安装")]),b])}const q=p(r,[["render",v],["__file","Elasticsearch跨集群迁移方案对比.html.vue"]]);export{q as default};
